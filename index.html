<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>완강기 순서 매칭 (클린 v2)</title>
<style>
  *{box-sizing:border-box} html,body{height:100%;margin:0;font-family:system-ui,'Noto Sans KR',sans-serif;background:#000}
  .stage{position:fixed;inset:0;overflow:hidden;-webkit-user-select:none;user-select:none}
  #bg{position:absolute;inset:0;width:100vw;height:100vh;object-fit:contain;opacity:.95}

  .left{position:absolute;left:0;top:0;width:56vw;height:100vh;padding:4vh 2vw;}
  .right{position:absolute;right:0;top:0;width:44vw;height:100vh;padding:4vh 2vw;}

  .slot{position:absolute;left:50%;transform:translateX(-50%); height:30vh; width:auto; z-index:1;}
  #slot010{top:6vh} #slot011{top:36vh} #slot012{top:66vh}

  .card{position:absolute; left:2vw; height:30vh; width:auto; cursor:grab; filter:drop-shadow(0 6px 16px rgba(0,0,0,.2)); transition:transform .15s; z-index:2;}
  #cardTop{ top:6vh }
  #cardMid{ top:36vh }
  #cardBot{ top:66vh }

  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(-10px)}50%{transform:translateX(10px)}75%{transform:translateX(-7px)}100%{transform:translateX(0)}}
  .shake{animation:shake .25s}
  .hit{outline:4px solid #48bb78; outline-offset:6px; border-radius:18px; box-shadow:0 0 0 6px rgba(72,187,120,.15) inset;}

  @media (max-width:900px){
    .left{width:60vw} .right{width:40vw}
  }
</style>

<div class="stage">
  <img id="bg" src="assets/bg.webp" alt="배경">
  <div class="left">
    <img id="cardTop" class="card" src="assets/완강기2.png" alt="완강기2">
    <img id="cardMid" class="card" src="assets/완강기3.png" alt="완강기3">
    <img id="cardBot" class="card" src="assets/완강기1.png" alt="완강기1">
  </div>
  <div class="right">
    <img id="slot010" class="slot" src="assets/010.webp" alt="010">
    <img id="slot011" class="slot" src="assets/011.webp" alt="011">
    <img id="slot012" class="slot" src="assets/012.webp" alt="012">
  </div>
  <audio id="ding" src="assets/correct.mp3" preload="auto"></audio>
</div>

<script>
  const MAP = new Map([
    ['cardBot','slot010'],
    ['cardTop','slot011'],
    ['cardMid','slot012']
  ]);

  const ding = document.getElementById('ding');
  const cards = ['cardTop','cardMid','cardBot'].map(id=>document.getElementById(id));
  const startPos = new Map();

  function moveTo(el, x, y){ el.style.left = x+'px'; el.style.top = y+'px'; }
  function rect(el){ return el.getBoundingClientRect(); }
  function saveStart(el){
    const r = rect(el);
    startPos.set(el.id, {x:r.left+window.scrollX, y:r.top+window.scrollY});
  }

  function layout(){
    cards.forEach(el=>{
      const r = rect(el);
      moveTo(el, r.left+window.scrollX, r.top+window.scrollY);
      el.style.position = 'absolute';
      saveStart(el);
    });
  }
  window.addEventListener('load', layout);
  window.addEventListener('resize', ()=>setTimeout(layout, 250));

  let drag=null, ox=0, oy=0;
  function pt(e){ return e.touches?{x:e.touches[0].clientX, y:e.touches[0].clientY}:{x:e.clientX, y:e.clientY}; }

  function down(e){
    drag = e.currentTarget;
    const p = pt(e);
    const r = rect(drag);
    ox = p.x - r.left; oy = p.y - r.top;
    drag.style.cursor='grabbing';
  }
  function move(e){
    if(!drag) return;
    const p = pt(e);
    moveTo(drag, p.x-ox+window.scrollX, p.y-oy+window.scrollY);
  }
  function intersects(a,b){ return a.left<b.right && a.right>b.left && a.top<b.bottom && a.bottom>b.top; }

  function up(){
    if(!drag) return;
    const targetId = MAP.get(drag.id);
    const target = document.getElementById(targetId);
    const a = rect(drag), b = rect(target);

    if(intersects(a,b)){
      moveTo(drag, b.left+window.scrollX, b.top+window.scrollY);
      try{ ding.currentTime=0; ding.play(); }catch(e){}
      target.classList.add('hit');
      drag.style.cursor='grab';
      drag=null;
      checkAll();
    } else {
      const wrongTouch = ['slot010','slot011','slot012'].some(id => id!==targetId && intersects(a, rect(document.getElementById(id))));
      if(wrongTouch){
        if(navigator.vibrate) navigator.vibrate(120);
        drag.classList.add('shake');
      }
      const s = startPos.get(drag.id);
      setTimeout(()=>{
        if(drag) drag.classList.remove('shake');
        moveTo(drag, s.x, s.y);
        drag.style.cursor='grab';
        drag=null;
      }, 260);
    }
  }

  function checkAll(){
    const ok = [...MAP.entries()].every(([cid,sid])=>{
      const c = rect(document.getElementById(cid));
      const s = rect(document.getElementById(sid));
      return Math.abs(c.left-s.left)<2 && Math.abs(c.top-s.top)<2;
    });
    if(ok){ setTimeout(()=>alert('정답입니다!'), 20); }
  }

  cards.forEach(el=>{
    el.addEventListener('mousedown', down);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', up);
    el.addEventListener('touchstart', e=>{ e.preventDefault(); down(e); }, {passive:false});
    window.addEventListener('touchmove', e=>{ e.preventDefault(); move(e); }, {passive:false});
    window.addEventListener('touchend', up);
  });
</script>
